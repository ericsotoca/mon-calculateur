<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur Carbone – Single File</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.3/Recharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.10/babel.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; }
        .fade-in { animation: fadeIn .5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">
    <div id="root" class="flex flex-col items-center justify-center min-h-screen">
        <div class="text-2xl font-semibold text-gray-600 animate-pulse">Chargement…</div>
    </div>

    <script type="text/babel">
        if (!window.React || !window.Recharts) throw new Error("Librairies manquantes");
        const { useState, useEffect } = React;
        const { PieChart, Pie, Cell, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        /* ---------- ICONES ---------- */
        const IconLeaf = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.77 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>;
        const IconCar = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>;
        const IconHome = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        const IconWifi = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 20h.01"/><path d="M2 8.82a15 15 0 0 1 20 0"/><path d="M5 12.859a10 10 0 0 1 14 0"/><path d="M8.5 16.429a5 5 0 0 1 7 0"/></svg>;
        const IconReset = () => <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;
        const IconShare = () => <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>;

        /* ---------- CONSTANTES ---------- */
        const EMISSION_FACTORS = {
            alimentation: { omnivore: 3, vegetarien: 1.7, vegan: 1.5, jeune: 0 },
            transport: { voiture: 0.192, bus: 0.105, train: 0.041, avion: 0.255 },
            logement: { electricite: 0.053, gaz: 0.206, fioul: 0.267, bois: 0.025 },
            numerique: { donnees: 0.06, streaming: 0.05 }
        };
        const MOY_FR = 9400;
        const COLORS = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6'];

        const VALEURS_MOYENNES = {
            repasOmnivore: '8', repasVegetarien: '4', repasVegan: '2', repasJeune: '0',
            voiture: '7500', bus: '0', train: '0', avion: '15000',
            electricite: '200', gaz: '100', fioul: '0', bois: '0',
            donnees: '50', streaming: '2'
        };

        function CarbonCalculator() {
            const [formData, setFormData] = useState(() => {
                try { return { ...VALEURS_MOYENNES, ...JSON.parse(localStorage.getItem('carbonForm')) }; } catch { return VALEURS_MOYENNES; }
            });
            const [results, setResults] = useState(null);
            const [history, setHistory] = useState(() => {
                try { return JSON.parse(localStorage.getItem('carbonHistory')) || []; } catch { return []; }
            });
            const [transportView, setTransportView] = useState('an');

            /* sauvegarde auto de la saisie */
            useEffect(() => { localStorage.setItem('carbonForm', JSON.stringify(formData)); }, [formData]);

            const handleChange = e => setFormData({ ...formData, [e.target.name]: e.target.value });

            /* partage */
            const shareResults = () => {
                if (!results) return;
                const text = `Mon empreinte carbone : ${results.tonnes} t CO₂e / an`;
                const url = new URL(location);
                url.searchParams.set('result', results.total);
                if (navigator.share) navigator.share({ title: 'Empreinte CO₂', text, url: url.href });
                else navigator.clipboard.writeText(`${text} – ${url.href}`);
            };

            /* convertit transport → annuel */
            const toAnnual = v => {
                const val = parseFloat(v) || 0;
                return transportView === 'semaine' ? val * 52 : transportView === 'mois' ? val * 12 : val;
            };

            /* calcule */
            const calculate = () => {
                const alim = (parseFloat(formData.repasOmnivore) || 0) * EMISSION_FACTORS.alimentation.omnivore * 52 +
                             (parseFloat(formData.repasVegetarien) || 0) * EMISSION_FACTORS.alimentation.vegetarien * 52 +
                             (parseFloat(formData.repasVegan) || 0) * EMISSION_FACTORS.alimentation.vegan * 52 +
                             (parseFloat(formData.repasJeune) || 0) * EMISSION_FACTORS.alimentation.jeune * 52;
                const trans = toAnnual(formData.voiture) * EMISSION_FACTORS.transport.voiture +
                              toAnnual(formData.bus) * EMISSION_FACTORS.transport.bus +
                              toAnnual(formData.train) * EMISSION_FACTORS.transport.train +
                              toAnnual(formData.avion) * EMISSION_FACTORS.transport.avion;
                const log = (parseFloat(formData.electricite) || 0) * EMISSION_FACTORS.logement.electricite * 12 +
                            (parseFloat(formData.gaz) || 0) * EMISSION_FACTORS.logement.gaz * 12 +
                            (parseFloat(formData.fioul) || 0) * EMISSION_FACTORS.logement.fioul * 12 +
                            (parseFloat(formData.bois) || 0) * EMISSION_FACTORS.logement.bois * 12;
                const num = (parseFloat(formData.donnees) || 0) * EMISSION_FACTORS.numerique.donnees * 12 +
                            (parseFloat(formData.streaming) || 0) * EMISSION_FACTORS.numerique.streaming * 365;
                const total = alim + trans + log + num;
                const res = {
                    alimentation: Math.round(alim),
                    transport: Math.round(trans),
                    logement: Math.round(log),
                    numerique: Math.round(num),
                    total: Math.round(total),
                    tonnes: (total / 1000).toFixed(2),
                    date: new Date().toISOString()
                };
                setResults(res);
                const h = [...history, res].slice(-10);
                setHistory(h);
                localStorage.setItem('carbonHistory', JSON.stringify(h));
            };

            const reset = () => {
                setFormData(VALEURS_MOYENNES);
                setTransportView('an');
                setResults(null);
                localStorage.removeItem('carbonForm');
            };

            const repasTotal = (parseFloat(formData.repasOmnivore) || 0) +
                               (parseFloat(formData.repasVegetarien) || 0) +
                               (parseFloat(formData.repasVegan) || 0) +
                               (parseFloat(formData.repasJeune) || 0);

            const pieData = results ? [
                { name: 'Alim', value: results.alimentation },
                { name: 'Transp', value: results.transport },
                { name: 'Logement', value: results.logement },
                { name: 'Num', value: results.numerique }
            ] : [];

            return (
                <div className="max-w-5xl mx-auto p-4 md:p-8 fade-in pb-20">
                    <header className="text-center mb-8">
                        <div className="flex justify-center items-center text-green-600 mb-2">
                            <IconLeaf /><h1 className="text-3xl font-bold ml-2">Calculateur Carbone</h1>
                        </div>
                        <p className="text-gray-600">Estimez votre impact annuel (kg CO₂e)</p>
                    </header>

                    <div className="grid md:grid-cols-2 gap-6 mb-6">
                        {/* ALIMENTATION */ }
                        <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-500">
                            <h2 className="text-lg font-bold mb-2 flex items-center"><IconLeaf /><span className="ml-2">Alimentation</span></h2>
                            <p className="text-xs text-gray-500 mb-3">Repas / semaine (total : <span className={repasTotal === 14 ? 'text-green-600 font-bold' : 'text-orange-600 font-bold'}>{repasTotal}</span> / 14)</p>
                            <div className="space-y-3">
                                {[
                                    { key: 'repasOmnivore', label: 'Omnivore' },
                                    { key: 'repasVegetarien', label: 'Végétarien' },
                                    { key: 'repasVegan', label: 'Végan' },
                                    { key: 'repasJeune', label: 'Jeûne (0 kg)' }
                                ].map(x => (
                                    <div key={x.key} className="flex justify-between items-center">
                                        <label className="text-sm">{x.label}</label>
                                        <input type="number" min="0" name={x.key} value={formData[x.key]} onChange={handleChange} className="w-20 p-2 border rounded focus:ring-2 focus:ring-green-500 outline-none" />
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* TRANSPORT */ }
                        <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500">
                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 gap-2">
                                <h2 className="text-lg font-bold flex items-center"><IconCar /><span className="ml-2">Transport</span></h2>
                                <div className="bg-gray-100 p-1 rounded-lg flex text-xs font-semibold">
                                    {['semaine', 'mois', 'an'].map(v => (
                                        <button key={v} onClick={() => setTransportView(v)} className={`px-3 py-1.5 rounded-md capitalize ${transportView === v ? 'bg-white text-blue-600 shadow' : 'text-gray-500'}`}>{v}</button>
                                    ))}
                                </div>
                            </div>
                            <p className="text-xs text-gray-500 mb-3">Distance par <span className="text-blue-600 font-bold">{transportView}</span> (km)</p>
                            <div className="space-y-3">
                                {['voiture', 'bus', 'train', 'avion'].map(m => (
                                    <div key={m} className="flex justify-between items-center">
                                        <label className="capitalize text-sm w-20">{m}</label>
                                        <input type="number" min="0" name={m} value={formData[m]} onChange={handleChange} className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" />
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* LOGEMENT */ }
                        <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-orange-500">
                            <h2 className="text-lg font-bold mb-2 flex items-center"><IconHome /><span className="ml-2">Logement (kWh/mois)</span></h2>
                            <div className="grid grid-cols-2 gap-4">
                                {['electricite', 'gaz', 'fioul', 'bois'].map(k => (
                                    <div key={k}>
                                        <label className="text-xs font-bold uppercase text-gray-500 block mb-1">{k}</label>
                                        <input type="number" min="0" name={k} value={formData[k]} onChange={handleChange} className="w-full p-2 border rounded focus:ring-2 focus:ring-orange-500 outline-none" />
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* NUMERIQUE */ }
                        <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-purple-500">
                            <h2 className="text-lg font-bold mb-2 flex items-center"><IconWifi /><span className="ml-2">Numérique</span></h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm mb-1">Données (Go/mois)</label>
                                    <input type="number" min="0" name="donnees" value={formData.donnees} onChange={handleChange} className="w-full p-2 border rounded focus:ring-2 focus:ring-purple-500 outline-none" />
                                </div>
                                <div>
                                    <label className="block text-sm mb-1">Streaming (h/jour)</label>
                                    <input type="number" min="0" step="0.1" name="streaming" value={formData.streaming} onChange={handleChange} className="w-full p-2 border rounded focus:ring-2 focus:ring-purple-500 outline-none" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="text-center mb-8 space-y-3">
                        <button onClick={calculate} className="bg-gray-800 text-white px-8 py-3 rounded-lg text-lg font-bold hover:bg-black transition shadow transform hover:scale-105">Calculer</button>
                        <div className="flex justify-center items-center gap-4">
                            <button onClick={reset} className="text-gray-500 text-sm hover:text-black flex items-center"><IconReset /> Réinitialiser</button>
                            {results && <button onClick={shareResults} className="text-gray-500 text-sm hover:text-black flex items-center"><IconShare /> Partager</button>}
                        </div>
                    </div>

                    {results && (
                        <div className="fade-in space-y-8 pb-12">
                            <div className="bg-white p-8 rounded-2xl shadow text-center">
                                <h2 className="text-2xl font-bold text-gray-700">Résultat annuel</h2>
                                <div className="text-6xl font-extrabold text-green-600 my-2">{results.tonnes}</div>
                                <div className="text-xl text-gray-500">tonnes CO₂e</div>
                                <div className="mt-4 inline-block bg-gray-100 px-4 py-2 rounded-full text-sm">Moyenne Française : <strong>{(MOY_FR / 1000).toFixed(1)} t</strong></div>
                            </div>

                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="bg-white p-4 rounded-xl shadow h-80">
                                    <h3 className="text-center font-bold mb-2">Répartition</h3>
                                    <ResponsiveContainer><PieChart><Pie data={pieData} cx="50%" cy="50%" outerRadius={90} dataKey="value" label>{pieData.map((e, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}</Pie><Tooltip formatter={v => `${Math.round(v)} kg`} /><Legend /></PieChart></ResponsiveContainer>
                                </div>
                                {history.length > 1 && (
                                    <div className="bg-white p-4 rounded-xl shadow h-80">
                                        <h3 className="text-center font-bold mb-2">Historique (total kg)</h3>
                                        <ResponsiveContainer><LineChart data={history}><CartesianGrid strokeDasharray="3 3" /><XAxis dataKey="date" tickFormatter={d => new Date(d).toLocaleDateString()} /><YAxis /><Tooltip labelFormatter={l => new Date(l).toLocaleString()} /><Line type="monotone" dataKey="total" stroke="#8b5cf6" strokeWidth={2} /></LineChart></ResponsiveContainer>
                                    </div>
                                )}
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow">
                                <h3 className="text-2xl font-bold text-gray-800 mb-6 text-center">Détail (kg CO₂e / an)</h3>
                                <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    {[
                                        { cat: 'Alimentation', icon: <IconLeaf />, color: 'text-green-600', vals: { Omnivore: results.alimentation * (parseFloat(formData.repasOmnivore) || 0) / repasTotal || 0, Végétarien: results.alimentation * (parseFloat(formData.repasVegetarien) || 0) / repasTotal || 0, Végan: results.alimentation * (parseFloat(formData.repasVegan) || 0) / repasTotal || 0, Jeûne: 0 } },
                                        { cat: 'Transport', icon: <IconCar />, color: 'text-blue-600', vals: { Voiture: parseFloat(formData.voiture) * EMISSION_FACTORS.transport.voiture * (transportView === 'semaine' ? 52 : transportView === 'mois' ? 12 : 1), Bus: parseFloat(formData.bus) * EMISSION_FACTORS.transport.bus * (transportView === 'semaine' ? 52 : transportView === 'mois' ? 12 : 1), Train: parseFloat(formData.train) * EMISSION_FACTORS.transport.train * (transportView === 'semaine' ? 52 : transportView === 'mois' ? 12 : 1), Avion: parseFloat(formData.avion) * EMISSION_FACTORS.transport.avion * (transportView === 'semaine' ? 52 : transportView === 'mois' ? 12 : 1) } },
                                        { cat: 'Logement', icon: <IconHome />, color: 'text-orange-600', vals: { Électricité: parseFloat(formData.electricite) * EMISSION_FACTORS.logement.electricite * 12, Gaz: parseFloat(formData.gaz) * EMISSION_FACTORS.logement.gaz * 12, Fioul: parseFloat(formData.fioul) * EMISSION_FACTORS.logement.fioul * 12, Bois: parseFloat(formData.bois) * EMISSION_FACTORS.logement.bois * 12 } },
                                        { cat: 'Numérique', icon: <IconWifi />, color: 'text-purple-600', vals: { Données: parseFloat(formData.donnees) * EMISSION_FACTORS.numerique.donnees * 12, Streaming: parseFloat(formData.streaming) * EMISSION_FACTORS.numerique.streaming * 365 } }
                                    ].map(bl => (
                                        <div key={bl.cat} className="border border-gray-100 rounded-xl p-4 bg-gray-50">
                                            <div className={`flex items-center mb-3 pb-2 border-b border-gray-200 ${bl.color}`}>{bl.icon}<h4 className="font-bold ml-2 text-lg">{bl.cat}</h4></div>
                                            <ul className="space-y-2 text-sm">
                                                {Object.entries(bl.vals).map(([k, v]) => (
                                                    <li key={k} className="flex justify-between"><span className="text-gray-600">{k}</span><span className="font-semibold bg-white px-2 py-1 rounded shadow-sm">{Math.round(v).toLocaleString()} kg</span></li>
                                                ))}
                                                <li className="flex justify-between pt-2 mt-2 border-t border-gray-200 font-bold text-gray-800"><span>Total</span><span>{Math.round(Object.values(bl.vals).reduce((a, b) => a + b, 0)).toLocaleString()} kg</span></li>
                                            </ul>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<CarbonCalculator />);
    </script>
</body>
</html>
