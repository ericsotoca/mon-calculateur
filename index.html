<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur Carbone Détaillé</title>
    
    <!-- 1. STYLE : Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. DEPENDANCES : CLOUDFLARE (Stable) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.3/Recharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.10/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div id="root" class="flex flex-col items-center justify-center min-h-screen">
        <div class="text-2xl font-semibold text-gray-600 animate-pulse">Chargement...</div>
    </div>

    <script type="text/babel">
        // Sécurité
        if (!window.React || !window.Recharts) { throw new Error("Librairies manquantes"); }

        const { useState, useEffect } = React;
        const { PieChart, Pie, Cell, BarChart, Bar, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        // --- ICONES ---
        const IconLeaf = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.77 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>;
        const IconCar = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>;
        const IconHome = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        const IconWifi = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><path d="M12 20h.01"/><path d="M2 8.82a15 15 0 0 1 20 0"/><path d="M5 12.859a10 10 0 0 1 14 0"/><path d="M8.5 16.429a5 5 0 0 1 7 0"/></svg>;
        const IconReset = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4 mr-2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;

        // --- DONNEES ---
        const EMISSION_FACTORS = {
            alimentation: { omnivore: { factor: 3 }, vegetarien: { factor: 1.7 }, vegan: { factor: 1.5 } },
            transport: { voiture: { factor: 0.192 }, bus: { factor: 0.105 }, train: { factor: 0.041 }, avion: { factor: 0.255 } },
            logement: { electricite: { factor: 0.053 }, gaz: { factor: 0.206 }, fioul: { factor: 0.267 }, bois: { factor: 0.025 } },
            numerique: { donnees: { factor: 0.06 }, streaming: { factor: 0.05 } }
        };

        const MOYENNE_FRANCAISE = { alimentation: 2300, transport: 2100, logement: 2200, numerique: 150, total: 9400 };
        const VALEURS_MOYENNES = { repasOmnivore: '14', repasVegetarien: '5', repasVegan: '2', voiture: '100', bus: '20', train: '10', avion: '2000', electricite: '200', gaz: '100', fioul: '0', bois: '0', donnees: '50', streaming: '2' };
        const COLORS = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6'];

        function CarbonCalculator() {
            const [formData, setFormData] = useState(VALEURS_MOYENNES);
            const [results, setResults] = useState(null);
            const [history, setHistory] = useState([]);
            const [transportPeriod, setTransportPeriod] = useState({ voiture: 'semaine', bus: 'semaine', train: 'semaine', avion: 'an' });

            useEffect(() => {
                try {
                    const saved = localStorage.getItem('carbonHistory');
                    if (saved) setHistory(JSON.parse(saved));
                } catch(e) {}
            }, []);

            const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});
            const handlePeriod = (mode, val) => setTransportPeriod({...transportPeriod, [mode]: val});
            
            const convertToAnnual = (val, mode) => {
                const v = parseFloat(val) || 0;
                const p = transportPeriod[mode];
                return p === 'semaine' ? v * 52 : p === 'mois' ? v * 12 : v;
            };

            const calculate = () => {
                // 1. Calculs Détaillés (Ligne par ligne)
                
                // Alimentation
                const vOmni = (parseFloat(formData.repasOmnivore)||0) * EMISSION_FACTORS.alimentation.omnivore.factor * 365;
                const vVege = (parseFloat(formData.repasVegetarien)||0) * EMISSION_FACTORS.alimentation.vegetarien.factor * 365;
                const vVegan = (parseFloat(formData.repasVegan)||0) * EMISSION_FACTORS.alimentation.vegan.factor * 365;
                const totalAlim = vOmni + vVege + vVegan;

                // Transport
                const vVoit = convertToAnnual(formData.voiture, 'voiture') * EMISSION_FACTORS.transport.voiture.factor;
                const vBus = convertToAnnual(formData.bus, 'bus') * EMISSION_FACTORS.transport.bus.factor;
                const vTrain = convertToAnnual(formData.train, 'train') * EMISSION_FACTORS.transport.train.factor;
                const vAvion = convertToAnnual(formData.avion, 'avion') * EMISSION_FACTORS.transport.avion.factor;
                const totalTrans = vVoit + vBus + vTrain + vAvion;

                // Logement
                const vElec = (parseFloat(formData.electricite)||0) * EMISSION_FACTORS.logement.electricite.factor * 12;
                const vGaz = (parseFloat(formData.gaz)||0) * EMISSION_FACTORS.logement.gaz.factor * 12;
                const vFioul = (parseFloat(formData.fioul)||0) * EMISSION_FACTORS.logement.fioul.factor * 12;
                const vBois = (parseFloat(formData.bois)||0) * EMISSION_FACTORS.logement.bois.factor * 12;
                const totalLog = vElec + vGaz + vFioul + vBois;

                // Numérique
                const vDonnees = (parseFloat(formData.donnees)||0) * EMISSION_FACTORS.numerique.donnees.factor * 12;
                const vStream = (parseFloat(formData.streaming)||0) * EMISSION_FACTORS.numerique.streaming.factor * 365;
                const totalNum = vDonnees + vStream;

                const grandTotal = totalAlim + totalTrans + totalLog + totalNum;

                // 2. Construction de l'objet résultat complet
                const res = {
                    alimentation: Math.round(totalAlim),
                    transport: Math.round(totalTrans),
                    logement: Math.round(totalLog),
                    numerique: Math.round(totalNum),
                    total: Math.round(grandTotal),
                    tonnes: (grandTotal/1000).toFixed(2),
                    date: new Date().toISOString(),
                    // Nouveau : Détail pour l'affichage tableau
                    details: [
                        { category: "Alimentation", icon: <IconLeaf />, color: "text-green-600", items: [
                            { label: "Repas Omnivore", val: vOmni },
                            { label: "Repas Végétarien", val: vVege },
                            { label: "Repas Végan", val: vVegan }
                        ]},
                        { category: "Transport", icon: <IconCar />, color: "text-blue-600", items: [
                            { label: "Voiture", val: vVoit },
                            { label: "Bus", val: vBus },
                            { label: "Train", val: vTrain },
                            { label: "Avion", val: vAvion }
                        ]},
                        { category: "Logement", icon: <IconHome />, color: "text-orange-600", items: [
                            { label: "Électricité", val: vElec },
                            { label: "Gaz", val: vGaz },
                            { label: "Fioul", val: vFioul },
                            { label: "Bois", val: vBois }
                        ]},
                        { category: "Numérique", icon: <IconWifi />, color: "text-purple-600", items: [
                            { label: "Données Mobiles/Wifi", val: vDonnees },
                            { label: "Streaming", val: vStream }
                        ]}
                    ]
                };

                setResults(res);
                const newHistory = [...history, res].slice(-10);
                setHistory(newHistory);
                localStorage.setItem('carbonHistory', JSON.stringify(newHistory));
            };

            const reset = () => {
                setFormData(VALEURS_MOYENNES);
                setResults(null);
            };

            const pieData = results ? [
                {name: 'Alim', value: results.alimentation},
                {name: 'Transp', value: results.transport},
                {name: 'Logement', value: results.logement},
                {name: 'Num', value: results.numerique}
            ] : [];

            return (
                <div className="max-w-6xl mx-auto p-4 md:p-8 fade-in">
                    <div className="text-center mb-10">
                        <div className="flex justify-center items-center text-green-600 mb-2">
                            <IconLeaf />
                            <h1 className="text-3xl font-bold ml-2 text-gray-800">Calculateur Carbone</h1>
                        </div>
                        <p className="text-gray-600">Estimez votre impact annuel (kg CO₂e)</p>
                    </div>

                    {/* FORMULAIRES */}
                    <div className="grid md:grid-cols-2 gap-6 mb-8">
                        {/* ALIM */}
                        <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-500">
                            <h2 className="text-lg font-bold mb-4 flex items-center"><IconLeaf /> <span className="ml-2">Alimentation</span></h2>
                            <p className="text-xs text-gray-500 uppercase font-bold mb-3">Repas par semaine</p>
                            <div className="space-y-3">
                                {['repasOmnivore', 'repasVegetarien', 'repasVegan'].map(name => (
                                    <div key={name} className="flex justify-between items-center">
                                        <label className="capitalize text-sm">{name.replace('repas', '')}</label>
                                        <input type="number" name={name} value={formData[name]} onChange={handleChange} className="w-20 p-2 border rounded focus:ring-2 focus:ring-green-500 outline-none" />
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* TRANSPORT */}
                        <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500">
                            <h2 className="text-lg font-bold mb-4 flex items-center"><IconCar /> <span className="ml-2">Transport</span></h2>
                            <div className="space-y-3">
                                {['voiture', 'bus', 'train', 'avion'].map(m => (
                                    <div key={m} className="flex gap-2 items-center">
                                        <label className="w-16 capitalize text-sm">{m}</label>
                                        <input type="number" name={m} value={formData[m]} onChange={handleChange} className="flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="km" />
                                        <select value={transportPeriod[m]} onChange={(e)=>handlePeriod(m, e.target.value)} className="bg-gray-100 p-2 rounded text-sm">
                                            <option value="semaine">/sem</option>
                                            <option value="mois">/mois</option>
                                            <option value="an">/an</option>
                                        </select>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* LOGEMENT */}
                        <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-orange-500">
                            <h2 className="text-lg font-bold mb-4 flex items-center"><IconHome /> <span className="ml-2">Logement (kWh/mois)</span></h2>
                            <div className="grid grid-cols-2 gap-4">
                                {['electricite', 'gaz', 'fioul', 'bois'].map(k => (
                                    <div key={k}>
                                        <label className="text-xs font-bold uppercase text-gray-500 block mb-1">{k}</label>
                                        <input type="number" name={k} value={formData[k]} onChange={handleChange} className="w-full p-2 border rounded focus:ring-2 focus:ring-orange-500 outline-none" />
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* NUMERIQUE */}
                        <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-purple-500">
                            <h2 className="text-lg font-bold mb-4 flex items-center"><IconWifi /> <span className="ml-2">Numérique</span></h2>
                            <div className="space-y-4">
                                <div><label className="block text-sm mb-1">Données (Go/mois)</label><input type="number" name="donnees" value={formData.donnees} onChange={handleChange} className="w-full p-2 border rounded focus:ring-2 focus:ring-purple-500 outline-none" /></div>
                                <div><label className="block text-sm mb-1">Streaming (h/jour)</label><input type="number" name="streaming" value={formData.streaming} onChange={handleChange} className="w-full p-2 border rounded focus:ring-2 focus:ring-purple-500 outline-none" /></div>
                            </div>
                        </div>
                    </div>

                    <div className="text-center mb-10">
                        <button onClick={calculate} className="bg-gray-800 text-white px-8 py-3 rounded-lg text-lg font-bold hover:bg-black transition shadow-lg transform hover:scale-105">Calculer mon empreinte</button>
                        <button onClick={reset} className="block mt-4 text-gray-500 text-sm hover:text-black mx-auto flex items-center"><IconReset /> Réinitialiser</button>
                    </div>

                    {results && (
                        <div className="fade-in space-y-8 pb-12">
                            {/* SCORE PRINCIPAL */}
                            <div className="bg-white p-8 rounded-2xl shadow-xl text-center">
                                <h2 className="text-2xl font-bold text-gray-700">Résultat Annuel</h2>
                                <div className="text-6xl font-extrabold text-green-600 my-2">{results.tonnes}</div>
                                <div className="text-xl text-gray-500">tonnes de CO₂e</div>
                                <div className="mt-4 inline-block bg-gray-100 px-4 py-2 rounded-full text-sm">Moyenne Française : <strong>{MOYENNE_FRANCAISE.total/1000} tonnes</strong></div>
                            </div>

                            {/* GRAPHIQUES */}
                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="bg-white p-4 rounded-xl shadow-lg h-80">
                                    <h3 className="text-center font-bold mb-2">Répartition</h3>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie data={pieData} cx="50%" cy="50%" outerRadius={80} fill="#8884d8" dataKey="value" label>
                                                {pieData.map((e, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                                            </Pie>
                                            <Tooltip formatter={(val) => Math.round(val) + " kg"} />
                                            <Legend />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                                {history.length > 1 && (
                                    <div className="bg-white p-4 rounded-xl shadow-lg h-80">
                                        <h3 className="text-center font-bold mb-2">Historique</h3>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <LineChart data={history}>
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis dataKey="date" tickFormatter={(d)=>new Date(d).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} />
                                                <YAxis />
                                                <Tooltip labelFormatter={(l)=>new Date(l).toLocaleString()} />
                                                <Line type="monotone" dataKey="total" stroke="#8b5cf6" strokeWidth={2} />
                                            </LineChart>
                                        </ResponsiveContainer>
                                    </div>
                                )}
                            </div>

                            {/* TABLEAU DE DÉTAILS - NOUVEAU ! */}
                            <div className="bg-white p-6 rounded-xl shadow-lg">
                                <h3 className="text-2xl font-bold text-gray-800 mb-6 text-center">Détail des émissions (kg CO₂e / an)</h3>
                                <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    {results.details.map((cat, idx) => (
                                        <div key={idx} className="border border-gray-100 rounded-xl p-4 bg-gray-50 hover:shadow-md transition">
                                            <div className={`flex items-center mb-3 pb-2 border-b border-gray-200 ${cat.color}`}>
                                                {cat.icon}
                                                <h4 className="font-bold ml-2 text-lg">{cat.category}</h4>
                                            </div>
                                            <ul className="space-y-3">
                                                {cat.items.map((item, i) => (
                                                    <li key={i} className="flex justify-between items-center text-sm">
                                                        <span className="text-gray-600">{item.label}</span>
                                                        <span className="font-semibold bg-white px-2 py-1 rounded shadow-sm">
                                                            {Math.round(item.val).toLocaleString()}
                                                        </span>
                                                    </li>
                                                ))}
                                                <li className="flex justify-between items-center pt-3 mt-2 border-t border-gray-200 font-bold text-gray-800">
                                                    <span>Total</span>
                                                    <span>
                                                        {Math.round(cat.items.reduce((acc, curr) => acc + curr.val, 0)).toLocaleString()} kg
                                                    </span>
                                                </li>
                                            </ul>
                                        </div>
                                    ))}
                                </div>
                            </div>

                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CarbonCalculator />);
    </script>
</body>
</html>
